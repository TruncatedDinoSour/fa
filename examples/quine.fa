include 'std/std.fa'

macro FILE_SIZE 1024 128 add end

macro FILE
    "examples/quine.fa" ro  -- ("examples/quine.fa"; 17)
    swap                    -- (17; "examples/quine.fa")
    1 drop                  -- ("examples/quine.fa")
end

macro main
    buffer file_buffer %FILE_SIZE

    0                        -- (0)
    %FILE                    -- (*"a.fa"; 0)
    %SYS_open sys 3          -- open("a.fa", O_RDONLY) => <fd>
    copy                     -- (<fd>; <fd>)

    %FILE_SIZE   swap        -- (<fd>; FILE_SIZE; <fd>)
    #file_buffer swap        -- (<fd>; *file_buffer; FILE_SIZE; <fd>)
    %SYS_read    sys 4       -- read(<fd>, *file_buffer, FILE_SIZE) => <read_bytes_c>

    #file_buffer             -- (*file_buffer; read_bytes_c; <fd>)
    %STDOUT                  -- (STDOUT; *file_buffer; read_bytes_c; <fd>)
    %SYS_write sys 4         -- write(STDOUT, *file_buffer, read_bytes_c) => <bytes_written_c>
    1 drop                   -- (fd)

    %SYS_close sys 2         -- close(fd) => ?success
    1 drop                   -- ()

    %EXIT_SUCCESS %exit
end

%main
